# Data Field Validation Feature

## Overview
Implement a comprehensive field-level validation system that provides visual feedback and AI-driven explanations for data extraction results.

## Core Requirements

### 1. Field-Level Validation Status
Every data field (both Project Schema fields and Object Collection properties) must have a validation status indicator:

**âœ… GREEN CHECKMARK (Valid/Complete)**
- Field has been successfully extracted by AI
- Data passes all validation rules
- User has manually verified the field
- Field is ready for final verification

**ðŸ”´ RED WARNING ICON (Invalid/Incomplete)**
- AI could not extract the data (field is empty/missing)
- Extracted data fails validation rules
- AI detected ambiguity or uncertainty in the data
- Data conflicts with knowledge base or extraction rules

### 2. Automatic Status Assignment
**Green Checkmarks Should Appear When:**
- AI successfully extracts data from documents
- Extracted data passes all defined validation rules
- Data meets quality standards set in knowledge base
- No conflicts detected with project rules

**Red Icons Should Appear When:**
- Field remains empty after extraction attempt
- AI expresses uncertainty about extracted value
- Data fails validation rules (e.g., date out of range, invalid format)
- Conflicts with knowledge base policies
- Data appears inconsistent or contradictory

### 3. AI Reasoning System
Each red icon must include detailed AI explanations:

**Missing Data Explanations:**
- "Could not locate employee salary information in the provided documents"
- "No pension contribution amounts found in current document set"
- "Company registration date not clearly stated in available files"

**Validation Rule Failures:**
- "Birth date 1985-13-45 is invalid - month cannot exceed 12"
- "Salary Â£450,000 exceeds maximum threshold of Â£250,000 set in validation rules"
- "Pension scheme type 'Hybrid Plus' not recognized - must be Defined Benefit, Defined Contribution, or Hybrid"

**Knowledge Base Conflicts:**
- "Employee age 15 conflicts with minimum working age policy in knowledge base"
- "Trustee appointment date 2025-01-01 is in the future - violates governance rules"
- "Contribution rate 25% exceeds regulatory maximum of 12% per UK pension regulations"

**Ambiguity Detection:**
- "Multiple salary figures found for John Smith (Â£35,000 and Â£42,000) - manual verification required"
- "Document contains conflicting scheme start dates (1995 and 1998) - please clarify"

## Implementation Details

### 4. User Interaction Flow
**Viewing Validation Status:**
1. User sees all fields with their validation icons
2. Clicking red icon shows AI reasoning in tooltip/popup
3. User can read explanation and take appropriate action

**Manual Override Process:**
1. User clicks red icon to view AI reasoning
2. User can manually enter/correct the field value
3. Upon manual entry, icon changes to green checkmark
4. System tracks that field was manually verified

**Re-validation Trigger:**
1. When new documents are uploaded
2. When validation rules are modified
3. When user requests re-extraction
4. System only re-validates fields with red icons (green fields remain untouched)

### 5. Technical Implementation

**Database Schema Addition:**
```sql
-- Add validation status to existing tables
ALTER TABLE extracted_project_data ADD COLUMN validation_status VARCHAR(20) DEFAULT 'pending';
ALTER TABLE extracted_project_data ADD COLUMN ai_reasoning TEXT;
ALTER TABLE extracted_project_data ADD COLUMN manually_verified BOOLEAN DEFAULT FALSE;

ALTER TABLE extracted_object_records ADD COLUMN validation_status VARCHAR(20) DEFAULT 'pending';
ALTER TABLE extracted_object_records ADD COLUMN ai_reasoning TEXT;
ALTER TABLE extracted_object_records ADD COLUMN manually_verified BOOLEAN DEFAULT FALSE;

-- Validation status values: 'valid', 'invalid', 'pending', 'manual'
```

**API Endpoints:**
```python
# Get validation status for a field
GET /api/sessions/{session_id}/fields/{field_id}/validation

# Update field value and validation status
PUT /api/sessions/{session_id}/fields/{field_id}/validate
{
    "value": "corrected_value",
    "manually_verified": true,
    "override_ai": true
}

# Trigger re-validation for all invalid fields
POST /api/sessions/{session_id}/revalidate
```

**Frontend Components:**
```tsx
// Validation Status Icon Component
<ValidationIcon 
  status="invalid" 
  reasoning="Employee age 15 conflicts with minimum working age policy"
  onManualVerify={handleManualVerify}
/>

// Field with Validation
<FieldInput 
  value={fieldValue}
  validationStatus="invalid"
  aiReasoning="Could not locate salary information in documents"
  onValueChange={handleFieldChange}
  onValidationOverride={handleValidationOverride}
/>
```

### 6. Validation Rules Integration
**Rule-Based Validation:**
- Check extracted values against project-specific validation rules
- Apply knowledge base policies to determine field validity
- Cross-reference with industry standards and regulations
- Validate data consistency across related fields

**AI Reasoning Generation:**
- AI should reference specific rules when explaining validation failures
- Include knowledge document citations in reasoning
- Provide actionable suggestions for resolving validation issues
- Explain required data format or acceptable value ranges

### 7. User Experience Features
**Progress Tracking:**
- Show completion percentage: "85% of fields validated (45/53)"
- Highlight sections needing attention
- Provide summary of remaining invalid fields

**Bulk Actions:**
- "Mark all extracted fields as verified" option
- "Re-validate all fields" button
- "Export validation report" functionality

**Visual Hierarchy:**
- Use color coding consistently across all interfaces
- Group validation issues by severity/type
- Provide clear visual distinction between validated and pending fields

## Success Criteria
1. **Clarity**: Users immediately understand field validation status
2. **Actionability**: AI reasoning provides clear next steps
3. **Efficiency**: Users can quickly resolve validation issues
4. **Accuracy**: Validation reflects actual data quality and rule compliance
5. **Consistency**: Validation behavior is predictable across all field types

## Example User Flow
1. User uploads pension documents
2. AI extracts 47 out of 53 fields successfully (green checkmarks)
3. 6 fields show red icons with specific AI reasoning
4. User reads AI explanations and identifies missing documents needed
5. User uploads additional documents
6. AI re-validates only the 6 invalid fields
7. 4 fields now validate successfully (turn green)
8. User manually verifies remaining 2 fields
9. All fields show green checkmarks - ready for final verification